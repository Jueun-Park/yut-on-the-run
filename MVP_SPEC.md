# yut-on-the-run MVP Spec

## 0. 목표
- 웹앱 기반 싱글 플레이 윷놀이 변형 게임.
- 정통 윷판(바깥길 + 대각선 + 중앙)에서 **말 4개를 모두 완주**시키면 클리어.
- 실패 조건 없음. 목표는 **클리어 턴 수 최소화**.
- “덱빌딩”은 카드 대신 **특수 윷가락 4개 슬롯 교체**로 구현(컨텐츠는 MVP 이후 확장 가능).

---

## 1. 핵심 용어
- **턴(Turn)**: 여러 번 던져 결과를 모으고, 모은 결과를 원하는 순서로 소모해 이동을 수행하는 한 사이클.
- **결과 토큰(Hand token)**: 한 번 던져 얻은 결과(도/개/걸/윷/모). 한 턴 동안 모아두었다가 이동 단계에서 1개씩 소비한다.
- **스택(Stack)**: 업기(말 올리기)로 묶인 말 그룹. 스택은 분리 이동 불가(항상 함께 이동).
- **노드(Node)**: 말이 위치할 수 있는 보드의 점. 바깥길 노드 `O0..O20`, 중앙 `C`, 대각선 노드 `A*`, `B*` 등.

---

## 2. 보드(정통 윷판) 모델
### 2.1 노드 구성
- 바깥길: `O0..O20`
  - `O0` = **집(HOME)** 을 의미하는 보드 밖 위치(화면에 표시하지 않아도 됨).
  - `O1..O20` = 바깥길의 실제 칸.
- 중앙: `C`
- 대각선 A (O5 ↔ C ↔ O15)
  - 진입: `O5 -> A1 -> A2 -> C`
  - 출구: `C -> A3 -> A4 -> O15`
- 대각선 B (O10 ↔ C ↔ O20)
  - 진입: `O10 -> B1 -> B2 -> C`
  - 출구: `C -> B3 -> B4 -> O20`

> 참고: 대각선 길이는 “옵션 M”(중앙까지 2칸 + 중앙 이후 2칸)을 사용한다.

### 2.2 특수 노드(Special Nodes)
- 각 노드는 다음 타입 중 하나를 가진다: **NORMAL**, **STICK**, **REFRESH**
- 특수 노드는 **말이 도착(landing)할 때만** 트리거된다.
  - 이동 도중 "지나가는" 경우에는 트리거되지 않는다.
  - 이미 노드에 서 있던 말은 해당 노드가 REFRESH로 인해 특수 노드가 되어도 트리거하지 않는다.
- **특수 노드 배치 기본 규칙**: 분기 노드(`O5`, `O10`, `C`)에는 특수 노드를 배치하지 않는다(NORMAL로 유지).

#### STICK 노드
- **도착 시 효과**: 새로운 윷가락 후보 **정확히 1개**를 즉시 제공한다.
- 플레이어는 다음 중 선택:
  - **교체**: 새 윷가락을 획득하고 기존 인벤토리의 윷가락 1개를 교체(인벤토리는 항상 4개 유지)
  - **폐기**: 새 윷가락을 버리고 인벤토리를 변경하지 않는다.
- **배치 개수**: 다수 배치(구체적 개수는 밸런스 조정 가능 파라미터, "많이" 배치하는 것을 목표로 함).

#### REFRESH 노드
- **도착 시 효과**: 허용된 노드들(분기 노드 제외) 전체에서 특수 노드 위치를 **재무작위화**한다.
- REFRESH 노드 자신도 재배치 대상에 포함된다(특수 노드 → NORMAL, NORMAL → 특수 노드 변환 가능).
- **배치 개수**: 기본값 **2개**.

### 2.3 분기 규칙(매우 중요)
- **분기 선택은 ‘이동을 시작할 때’만** 발생한다.
- 이동 중에 분기 노드를 “지나가도” 분기 선택은 발생하지 않는다.
- 분기 노드:
  - `O5`: 바깥길 계속 vs 대각선 A 진입
  - `O10`: 바깥길 계속 vs 대각선 B 진입
  - `C`: O15 방향 출구(A3) vs O20 방향 출구(B3)
- **`O15`에서는 분기 불가**(바깥길로만 진행).

### 2.4 완주 규칙
- 완주는 "정확히 맞출 필요 없음".
- `O20`에 **도착하는 것만으로는 완주가 아님**.
- `O20`에서 출발하여 **1 step 이상 소비하려 할 때** 즉시 완주(FINISHED) 처리한다(오버슛 규칙).
  - 즉, `O20`을 "지나치려 할 때" 완주 처리한다.

---

## 3. 말/스택(업기) 규칙
### 3.1 말 개수 및 상태
- 말 4개.
- 각 말은 `HOME(O0)`, `ON_BOARD(nodeId)`, `FINISHED` 중 하나의 상태를 가진다.
- 실제 구현에서는 말이 개별로 움직이지 않고 **스택 단위**로 움직인다.

### 3.2 업기(자동 합치기)
- 이동 후 도착 노드에 다른 스택이 존재하면 **즉시 자동 병합**한다.
- 병합된 스택은 이후 **분리 이동 불가**(항상 함께 이동).

---

## 4. 턴 구조(Throw → Start Move → Play)
### 4.1 턴 페이즈
1) **Throw Phase (던지기 단계)**
- 상태값: `throwsRemaining`(남은 던지기 횟수), `hand`(결과 토큰 목록)
- 턴 시작 시: `throwsRemaining = 1`, `hand = []`
- 플레이어는 `throwsRemaining > 0`인 동안 [던지기] 버튼으로 결과를 획득한다.
- 결과가 **윷 또는 모**이면: `throwsRemaining += 1` (같은 턴에 던질 기회가 증가)
- 던질 기회가 0이 되면 [던지기]는 비활성화되고, **[이동 시작]** 버튼이 활성화된다.

#### 던지기 버튼 인터랙션 및 손맛 (Throw button input & haptics)
- **혼합 탭/누르고 있기 방식**:
  - 포인터 다운(pointer down) 시: 굴리기(rolling) 상태 진입
  - 최소 굴리기 지속 시간: **0.5초**
    - 플레이어가 0.5초 전에 버튼을 떼면, 계속 굴리기를 유지하고 0.5초에 자동 커밋
  - 최대 굴리기 지속 시간: **3.0초**
    - 3.0초에 도달하면 버튼을 떼지 않아도 자동 커밋
  - 0.5초 이후 ~ 3.0초 이전에 버튼을 떼면 즉시 커밋
- **햅틱 피드백 (손맛)**:
  - Web Vibration API(`navigator.vibrate`) 사용; 지원되지 않으면 조용히 무시(no-op)
  - **굴리기 틱 진동**: 굴리기 중 **0.5초마다** 진동 (권장: 5–10ms)
  - **커밋 확인 진동**: 커밋 시 **1회** 진동 (권장: 30–50ms)
  - 틱과 커밋이 동시에 발생하면 커밋 진동을 우선하고, 커밋 시 틱 타이머를 중지
  - 진동 토글 설정은 제공하지 않음; 지원 가능한 기기에서만 best-effort로 작동
- **RNG 소비 규칙**:
  - 엔진 RNG는 **커밋 시점에 정확히 1번만** 소비
  - 굴리기 비주얼은 RNG를 소비하지 않음 (임시 결과 셔플 가능하나 RNG는 커밋 시에만)
- **최소 UI 가이드**:
  - 굴리기 상태는 시각적으로 표시되어야 함 (버튼 상태/아이콘/텍스트)
  - 비주얼은 임시 결과를 셔플할 수 있으나, 실제 RNG는 커밋 시에만 소비

2) **Move Start (이동 시작 버튼)**
- 플레이어가 [이동 시작]을 누르면 Play Phase로 진입한다.

3) **Play Phase (이동 처리 단계)**
- `hand`에 있는 결과 토큰을 **원하는 순서로** 하나씩 선택해 소비한다.
- 토큰 1개를 선택하면:
  - 이동시킬 대상(스택 또는 HOME의 새 말) 선택 → (필요 시) 분기 옵션 선택 → 이동 적용.
- 토큰을 1개 적용할 때마다 hand에서 제거된다.
- **노드 이벤트 처리**: 각 이동 토큰 해결 직후, 도착 노드가 특수 노드(STICK, REFRESH)이면 해당 이벤트를 즉시 처리한다.
  - STICK 노드: 새 윷가락 후보 제공 → 교체/폐기 선택 모달 표시.
  - REFRESH 노드: 특수 노드 위치 재무작위화 즉시 적용.
- `hand`가 비면 턴 종료 → `turn += 1` 후 다음 턴의 Throw Phase로 진행.

4) **Reward Phase (보상 선택 모달)**
- 이동 결과로 말(스택)이 완주하면 보상 선택 단계로 잠시 진입한다.
- 보상 선택이 끝나면 다시 Play Phase로 돌아가 hand의 나머지 토큰을 계속 처리한다.

5) **Game Over**
- 4말 모두 FINISHED이면 즉시 게임 종료.
- 표시: 총 턴 수, 시드, 결과 요약(복사 가능).
- **표시 필드**:
  - 총 턴 수
  - 게임 시드 (seed)
  - 수집한 유물 목록
  - 최종 윷가락 슬롯 상태
- **공유 기능**:
  - **Copy Short** 버튼: 게임명/모드, 시드, 턴 수를 포함한 1줄 짧은 텍스트 복사
  - **Copy Long** 버튼: 시드, 턴 수, 유물 목록, 윷가락 목록을 포함한 상세 텍스트 복사
  - **클립보드 실패 시 대체 동작**: 클립보드 API가 실패하거나 사용 불가능한 경우, 텍스트를 선택 가능한 영역에 표시하고 수동 복사 안내를 제공한다.

---

## 5. 이동 규칙(steps 소비)
### 5.1 결과(step) 정의
- 결과는 다음 중 하나: 도(1), 개(2), 걸(3), 윷(4), 모(5)
- **백도는 없음**.

#### 던지기 결과 모델(4-stick 샘플링)
- 플레이어는 **4개의 윷가락 슬롯**을 가진다.
- 던지기 시, 4개의 윷가락을 동시에 던진다.
- 각 윷가락은 독립적으로 **앞면(Front)** 또는 **뒷면(Back)** 결과를 낸다.
  - 각 윷가락의 Front/Back 확률 및 효과는 윷가락별 속성으로 정의된다(컨텐츠는 추후 확장).
- **backCount**: 4개 윷가락 중 뒷면이 나온 개수(0..4)를 계산한다.
- backCount를 다음과 같이 결과로 매핑한다:
  - `backCount = 1` → **도(DO)**, steps = 1
  - `backCount = 2` → **개(GAE)**, steps = 2
  - `backCount = 3` → **걸(GEOL)**, steps = 3
  - `backCount = 4` → **윷(YUT)**, steps = 4
  - `backCount = 0` → **모(MO)**, steps = 5
- **보너스 던지기 규칙**: 결과가 **윷(YUT)** 또는 **모(MO)**이면 `throwsRemaining += 1` (같은 턴에 던질 기회 증가).

### 5.2 HOME에서의 이동(스폰 포함)
- HOME을 `O0`로 모델링한다.
- `O0 -> O1`이 “보드로 나오는 1 step”이다.
- 따라서:
  - 도(1)을 HOME에서 사용하면 최종 위치는 `O1`.
  - 모(5)을 HOME에서 사용하면 최종 위치는 `O5`.
- **HOME 스폰 선택**: Play Phase에서 HOME을 선택하면 **자동으로** HOME에 있는 첫 번째 말(가장 낮은 ID)을 스폰하고 이동을 적용한다. 수동 선택 없음.

### 5.3 분기 처리(출발 시점만)
- 이동 시작 노드가 분기 노드(`O5`, `O10`, `C`)이면 플레이어는 “첫 step의 다음 노드”를 선택한다.
- 그 이후 남은 step들은 강제 경로로 자동 진행한다(이동 도중 분기 무시).
- **C에서의 분기**: C에서 출발할 때 플레이어는 A3(O15 방향) 또는 B3(O20 방향)를 선택할 수 있다.

### 5.4 이동 후 취소 불가
- 결과 토큰을 선택하고 이동을 적용한 후에는 **되돌리기(undo) 기능이 없다**.
- 잘못된 선택(미스탭)도 플레이의 일부로 간주한다.

---

## 6. 유물(리워드) 규칙 + 업기 디메리트
### 6.1 보상 트리거
- 어떤 이동으로 스택이 완주(FINISHED)하면 유물 보상을 1회 제공한다.
- **MVP에서는 유물은 완주 시에만 제공된다.** 보드 노드 기반의 유물 획득은 MVP에 포함되지 않는다.

### 6.2 후보 수(업기 디메리트, 옵션 A)
- 완주한 스택에 포함된 말 수를 `k`라고 할 때,
- 유물 후보 수 `n = max(1, 4 - k)`
  - k=1 → 후보 3개 중 1개 선택
  - k=2 → 후보 2개 중 1개 선택
  - k=3 → 후보 1개 중 1개 선택
  - k=4 → 후보 1개 중 1개 선택(또는 추후 밸런스에 따라 0개로 변경 가능)
- 선택한 유물은 즉시 획득/적용된다.

> MVP에서는 유물 효과의 구체 내용은 별도 데이터(content)로 정의하며, 엔진에는 “유물 획득 이벤트”와 “후보 생성 RNG 소비”만 우선 구현한다.

---

## 7. 덱빌딩(특수 윷가락 4슬롯) MVP 범위
- 플레이어는 4개의 “윷가락 슬롯”을 가진다.
- MVP 1차 목표는 “기본 윷 던지기 + 턴/이동/보상 루프” 완성.
- **시드 기반 RNG(MVP 요구사항)**:
  - 동일한 시드/선택이면 동일한 런을 재현 가능하게 한다.
  - 플레이어는 게임 시작 시 시드를 입력할 수 있다.
  - 시드는 게임 결과 공유 시 포함된다.
- 이후 확장:
  - 특수 윷가락 10+종, 유물 10+종을 데이터 드리븐으로 추가.

---

## 8. UI 최소 요구사항
- 상단: 현재 턴 수
- **Settings**:
  - 설정(⚙️) 버튼으로 접근
  - **시드 입력**: 최대 10자까지 입력 가능
  - **시드 정규화 규칙**: 입력된 시드는 `trim()`으로 정규화한다.
  - **빈 시드 처리**: 정규화 후 빈 문자열이면 랜덤 시드를 생성하여 사용한다(단, 생성된 시드도 저장/표시하여 공유 가능).
  - **새 게임 시작 버튼**: 입력된(또는 생성된) 시드로 새 게임을 시작한다.
- Throw Phase:
  - `throwsRemaining` 표시
  - [던지기] 버튼
  - `hand` 토큰 표시(누적)
  - [이동 시작] 버튼(throwsRemaining==0일 때 활성)
- Play Phase:
  - `hand` 토큰들을 버튼/칩으로 표시(순서 선택 가능)
  - 이동 대상(스택/집) 선택 UI
  - (필요 시) 분기 옵션 선택 UI
- Reward:
  - 유물 후보 `n`개를 보여주고 1개 선택
- 종료:
  - 클리어 턴 수 및 요약 텍스트, 복사 버튼

---

## 9. MVP UI/UX 확정 사항

### 9.1 레이아웃 (모바일 우선)
- **모바일 우선 세로 레이아웃**을 사용한다.
  - 상단: 고정(sticky) 헤더 (턴 수 등)
  - 중앙: 정사각형 보드 영역
  - 하단: 고정(sticky) 액션 트레이 (던지기 버튼, hand 토큰 등)
- **데스크톱**에서도 동일한 세로 레이아웃을 사용하며, 좌우 여백을 허용한다.

### 9.2 보드 배치 및 시각화 (정통 윷판)
- **전통적인 윷판 비주얼 배치**를 사용한다.
- 좌표는 고정 배치를 따른다.
- **O1 위치**: 보드 **오른쪽 하단**에 위치한다.
- **바깥길 번호 증가 방향**: O1에서 O20까지 **시계 반대 방향(counter-clockwise)**으로 증가한다.
- **강조 노드 (크게 표시)**: **O5, O10, O15, O20, C**
  - 이들은 다른 노드보다 크게 렌더링하여 시각적으로 강조한다.

### 9.3 SVG 보드 (Option B)
- **연결선은 엔진의 그래프 엣지(BOARD_GRAPH의 from -> to)로부터 엄격하게 도출**한다.
- 엣지가 아닌 장식용 선은 그리지 않는다.

### 9.4 터치/인터랙션
- **각 노드는 최소 44px의 보이지 않는 원형 터치 타겟**을 가져야 한다.
- **제약 UI (Constraint UI)**: 유효한 액션만 하이라이트/활성화한다.
  - 유효하지 않은 선택지는 비활성화 또는 숨김 처리한다.

### 9.5 말/스택 표시
- **노드에 정확히 1개의 말이 있을 경우**:
  - 노드보다 작은 원형 말 1개를 그린다.
- **스택(2개 이상)인 경우**:
  - 말 위에 숫자 배지(2/3/4)를 표시한다.
- **말 외관**:
  - 모든 말은 **동일한 외관**을 가진다 (개별 ID나 색상 구분 없음).

### 9.6 이동 및 미리보기
- **이동 플로우**:
  1. 토큰을 던진다(Throw Phase).
  2. [이동 시작] 버튼을 클릭한다.
  3. hand에서 토큰을 선택한다.
  4. 말/스택(또는 HOME)을 선택한다.
  5. 활성화된 목적지 노드를 선택한다.
  6. **즉시 이동이 실행된다 (확인 버튼 없음)**.
- **이동 미리보기**:
  - **목적지 노드만 하이라이트**한다 (경로 미리보기 없음).
- **미스터치 정책**:
  - 미스터치(잘못된 터치)도 게임의 일부로 간주한다.
  - UI에 가벼운 한 줄 안내 문구를 포함할 수 있다: *"미스터치도 게임의 일부…"*
  - 이것은 주요 UX 원칙이 아니라 가벼운 언급 수준으로 처리한다.

### 9.7 분기 선택 (보드 내 처리)
- **분기 선택은 보드 위에서 직접 수행**한다 (모달 없음).
- 분기가 필요한 경우:
  - 두 개의 후보 다음 노드를 하이라이트한다.
  - 플레이어가 하나를 탭하여 선택한다.

### 9.8 HOME 및 FINISHED 영역
- **HOME (O0)**:
  - 보드 UI 밖에 위치하며, 보드 노드로 렌더링하지 않을 수 있다.
- **FINISHED 영역**:
  - 보드 **내부 하단 영역**에 위치한다.
  - **가로로 배열된 4개의 슬롯**을 가진다.
  - 슬롯은 완주한 말의 개수만 표현한다 (어떤 말이 완주했는지 식별하지 않음).

### 9.9 특수 노드 표시
- 특수 노드는 **아이콘 + 색상**으로 표시한다.
- **STICK 노드 착지**:
  - 필수 모달이 다른 입력을 차단한다.
  - 윷가락 교체/폐기 선택을 처리한다.
- **REFRESH 노드 착지**:
  - 토스트 알림으로 표시한다.
  - 특수 노드 위치가 재무작위화되었음을 알린다.
- **통과(passing through)**는 트리거하지 않는다; **착지(landing)만 트리거**한다.

### 9.10 줌
- **MVP에서는 핀치 줌을 지원하지 않는다**.
- 플레이테스트 이후 재검토한다.

### 9.11 Game Over 화면 및 공유 기능
- **표시 요소**:
  - 게임 클리어 메시지
  - 총 턴 수
  - 사용된 시드
  - 수집한 유물 목록
  - 최종 윷가락 슬롯 상태

- **공유 텍스트 형식**:
  - **Copy Short (짧은 복사)**:
    - 권장 템플릿 (1줄):
      ```
      윷판 달리기 클리어! Seed: [시드], 턴: [턴수]
      ```
    - 예시: `윷판 달리기 클리어! Seed: abc123, 턴: 42`

  - **Copy Long (상세 복사)**:
    - 권장 템플릿 (여러 줄):
      ```
      윷판 달리기 클리어!
      Seed: [시드]
      턴: [턴수]
      유물: [유물1], [유물2], [유물3]
      윷가락: [윷가락1], [윷가락2], [윷가락3], [윷가락4]
      ```
    - 예시:
      ```
      윷판 달리기 클리어!
      Seed: abc123
      턴: 42
      유물: 신속의 부적, 행운의 말발굽, 중앙 지름길
      윷가락: 기본 윷가락, 기본 윷가락, 행운 윷가락, 기본 윷가락
      ```

- **클립보드 복사 동작**:
  1. [Copy Short] 또는 [Copy Long] 버튼 클릭
  2. 클립보드 API를 사용하여 텍스트 복사 시도
  3. **성공**: 사용자에게 "복사 완료" 피드백 표시
  4. **실패 또는 API 미지원**: 텍스트를 선택 가능한 텍스트 영역(textarea)에 표시하고 "텍스트를 선택하여 수동으로 복사하세요" 안내 메시지 표시

- **수락 기준**:
  - Copy Short는 최소한 게임명/모드, 시드, 턴 수를 포함해야 한다.
  - Copy Long은 시드, 턴 수, 유물 목록, 윷가락 목록을 포함해야 한다.
  - 클립보드 API 실패 시 대체 UI(선택 가능한 텍스트 영역)를 제공해야 한다.
  - 시드는 정규화 규칙(`trim()`)에 따라 처리되고, 빈 시드는 랜덤 시드로 대체되어야 한다.

---

## 10. 비목표(의도적으로 MVP에서 제외)
- PvP/상대 말 잡기
- 백도
- 분리 이동
- 이동 중 분기 선택(출발 시점 외 분기 금지)
- 중앙에서의 “정통 강제 출구” (MVP에서는 C에서 O15/O20 출구 선택 허용)
- 고급 애니메이션/그래픽(프로토타입 우선)

---

## 11. 테스트 시나리오(간단 체크)
- HOME에서 도(1) 사용 → O1
- HOME에서 모(5) 사용 → O5 (분기 선택 없음, 다음 이동에서 O5 출발 시 분기 가능)
- O5에서 도(1) 사용 시:
  - 바깥길 선택 → O6
  - 대각선 선택 → A1
- C에서 도(1) 사용 시:
  - A3 선택 → A3
  - B3 선택 → B3
- 업기:
  - 스택 X가 어떤 노드에 도착했을 때 다른 스택 Y가 있으면 자동 병합
- 완주:
  - O19에서 도(1) 사용 → O20 도착, 아직 완주 아님
  - O20에 있고 도(1)을 사용해 한 칸 더 가려 하면 FINISHED (오버슛)
  - O19에서 개(2) 사용 → O20을 지나므로 즉시 FINISHED (오버슛)
- 보상 후보 수:
  - k=1 완주 → 3개 후보
  - k=2 완주 → 2개 후보
- 4-stick 샘플링:
  - 4개 윷가락을 던져 backCount 계산 → 결과 매핑 확인
  - backCount=0 → 모(5), backCount=1 → 도(1), backCount=2 → 개(2), backCount=3 → 걸(3), backCount=4 → 윷(4)
  - 윷/모 결과 시 throwsRemaining 증가 확인
- 특수 노드:
  - STICK 노드 도착 → 새 윷가락 후보 1개 제공 → 교체/폐기 선택
  - REFRESH 노드 도착 → 특수 노드 재배치 즉시 적용
  - 이동 도중 특수 노드 "지나가기"는 트리거 안 됨
  - REFRESH 후 이미 서 있던 말은 특수 노드가 되어도 트리거 안 됨

